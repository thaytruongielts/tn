import React, { useState, useEffect, useRef } from 'react';
import { BookOpen, CheckCircle, XCircle, RefreshCw, Trophy, ArrowRight } from 'lucide-react';

const IdiomApp = () => {
  const [currentQuestion, setCurrentQuestion] = useState(null);
  const [userInput, setUserInput] = useState('');
  const [feedback, setFeedback] = useState(null); // 'correct', 'incorrect', or null
  const [stats, setStats] = useState({ correct: 0, total: 0 });
  const [history, setHistory] = useState([]); // To track session history
  const inputRef = useRef(null);

  // Full database of 200 idioms based on user request
  const rawData = [
    { id: 1, en: "A breath of fresh air", vn: "một luồng sinh khí mới" },
    { id: 2, en: "A month of Sundays", vn: "rất lâu, hiếm khi xảy ra" },
    { id: 3, en: "A slap on the wrist", vn: "sự khiển trách nhẹ nhàng" },
    { id: 4, en: "A streak of luck", vn: "một chuỗi may mắn liên tiếp" },
    { id: 5, en: "A sweet tooth", vn: "một người hảo ngọt, rất thích ăn đồ ngọt" },
    { id: 6, en: "A whole new ball game", vn: "một tình huống hoàn toàn khác lúc trước, cục diện hoàn toàn mới" },
    { id: 7, en: "A wolf in sheep’s clothing", vn: "cáo già đóng giả cừu non, người có lòng dạ xấu xa bên trong mà vẻ bên ngoài lại đàng hoàng, tử tế" },
    { id: 8, en: "Absence makes the heart grow fonder", vn: "càng xa càng nhớ" },
    { id: 9, en: "Apples and oranges", vn: "ý nói hai vật so sánh rất khác nhau, khác nhau một trời một vực" },
    { id: 10, en: "As drunk as drunk", vn: "uống say mèm" },
    { id: 11, en: "Bachelor party", vn: "bữa tiệc dành cho những người đàn ông sắp lấy vợ, tiệc độc thân" },
    { id: 12, en: "Back the wrong horse", vn: "đưa ra quyết định sai, ủng hộ sai người/cái gì" },
    { id: 13, en: "Bare one’s teeth", vn: "nhe răng những lúc giận dữ" },
    { id: 14, en: "Be back on your feet", vn: "hồi phục, khỏe mạnh trở lại sau một thời gian đau ốm" },
    { id: 15, en: "Barking up the wrong tree", vn: "tìm cách giải quyết một vấn đề bằng cách sai lầm" },
    { id: 16, en: "Be fresh as a daisy", vn: "tràn đầy năng lượng" },
    { id: 17, en: "Be in knots", vn: "dạ dày cảm thấy căng và khó chịu vì bạn quá lo lắng hoặc phấn khích" },
    { id: 18, en: "Be in the dark", vn: "không được thông báo về những điều cần biết, mù tịt" },
    { id: 19, en: "Be off the mark", vn: "không đúng, sai" },
    { id: 20, en: "Be out of your depth", vn: "trong tình thế khó khăn" },
    { id: 21, en: "Beauty is only skin deep", vn: "tốt gỗ hơn tốt nước sơn" },
    { id: 22, en: "Bed of nails", vn: "một tình huống khó khăn" },
    { id: 23, en: "Best thing since sliced bread", vn: "một cái gì/ người nào đó rất tốt, quan trọng hay hữu ích" },
    { id: 24, en: "Big guns", vn: "người quan trọng hay có quyền lực" },
    { id: 25, en: "Birds of a feather", vn: "người có tính cách giống nhau" },
    { id: 26, en: "Bite off more than you can chew", vn: "cố gắng làm điều gì đó mà quá khó với bạn" },
    { id: 27, en: "Bite the bullet", vn: "nhẫn nhục chịu đựng, ngậm đắng nuốt cay" },
    { id: 28, en: "Blood is thicker than water", vn: "một giọt máu đào hơn ao nước lã" },
    { id: 29, en: "Blow someone a kiss", vn: "hôn lên tay" },
    { id: 30, en: "Blow the whistle on someone", vn: "tự thú, báo cáo" },
    { id: 31, en: "Boil the ocean", vn: "lãng phí thời gian, không đáng làm, không thể làm được" },
    { id: 32, en: "Break new ground", vn: "phát hiện ra cái gì mới" },
    { id: 33, en: "Break out in a cold sweat", vn: "đột nhiên trở nên lo lắng, sợ hãi" },
    { id: 34, en: "Bull's eye", vn: "điểm đen (môn bắn súng]" },
    { id: 35, en: "Buy time", vn: "câu giờ" },
    { id: 36, en: "Change hands", vn: "đổi chủ, đổi quyền sở hữu" },
    { id: 37, en: "Child support", vn: "trợ cấp nuôi con" },
    { id: 38, en: "Close the door on something", vn: "không xét đến việc gì, làm cho không có khả năng thực hiện được" },
    { id: 39, en: "Come to a head", vn: "đạt đến đỉnh điểm" },
    { id: 40, en: "Cook the books", vn: "thay đổi số liệu một cách bất hợp pháp" },
    { id: 41, en: "Cool one's heels", vn: "đứng chờ mỏi chân" },
    { id: 42, en: "Cut corners", vn: "đi tắt, đốt cháy giai đoạn" },
    { id: 43, en: "Do someone a good turn", vn: "làm điều gì đó giúp đỡ người khác" },
    { id: 44, en: "Do time", vn: "ngồi tù" },
    { id: 45, en: "Don’t let the fox guard the henhouse", vn: "giao trứng cho ác" },
    { id: 46, en: "Down and out", vn: "sa cơ thất thế" },
    { id: 47, en: "Down in the dumps", vn: "không vui" },
    { id: 48, en: "Dressed to kill", vn: "ăn mặc rất đẹp, sành điệu" },
    { id: 49, en: "Drive a hard bargain", vn: "mong đợi nhận lại rất nhiều điều gì từ những gì hạp đã làm" },
    { id: 50, en: "Drop the ball", vn: "gây ra lỗi, mắc lỗi do làm điều gì ngu ngốc" },
    { id: 51, en: "Drown your sorrows", vn: "uống rượu để quên đi vấn đề của bạn" },
    { id: 52, en: "Early bird", vn: "người luôn thức dậy sớm" },
    { id: 53, en: "Easier said than done", vn: "nói thì dễ làm thì khó" },
    { id: 54, en: "Eat like a bird", vn: "ăn ít, ăn như mèo" },
    { id: 55, en: "Eat your words", vn: "thừa nhận điều gì bạn nói trước đây là sai" },
    { id: 56, en: "Every cloud has a silver lining", vn: "dù hoàn cảnh khó khăn, tồi tệ như thế nào thì cũng có một điều tốt đẹp hơn" },
    { id: 57, en: "Explore all avenues", vn: "suy tính đến các hướng/bước để tránh xảy ra vấn đề/ hậu quả xấu" },
    { id: 58, en: "Face the music", vn: "Chấp nhận những lời chỉ trích hoặc sự trừng phạt cho những gì bạn đã làm" },
    { id: 59, en: "Far-fetched", vn: "rất khó có thể là sự thật, khó tin" },
    { id: 60, en: "Fill in for someone", vn: "làm hết sức có thể để thay thế (lấp chỗ trống) cho ai đó" },
    { id: 61, en: "Flat broke", vn: "rỗng túi, cháy túi" },
    { id: 62, en: "Flat out", vn: "hoàn toàn, hết sức" },
    { id: 63, en: "Get a foot in the door", vn: "bước vào công việc kinh doanh ở qui mô nhỏ nhưng có cơ hội thành công trong tương lai" },
    { id: 64, en: "Get cold feet", vn: "lo lắng, sợ hãi" },
    { id: 65, en: "Get even with someone", vn: "trả thù ai, trả đũa ai" },
    { id: 66, en: "Get your ducks in a row", vn: "chuẩn bị tốt hoặc tổ chức tốt cho điều gì đó sắp xảy ra" },
    { id: 67, en: "Get the ball rolling", vn: "bắt đầu điều gì đó" },
    { id: 68, en: "Give someone a run for their money", vn: "không cho phép ai đó chiến thắng dễ dàng" },
    { id: 69, en: "Give someone food for thought", vn: "đưa một ý kiến đáng được xem xét" },
    { id: 70, en: "Give someone the green light", vn: "cho phép ai hành động, bật đèn xanh cho ai" },
    { id: 71, en: "Give something your best shot", vn: "làm điều gì đó tốt nhất có thể" },
    { id: 72, en: "Go bananas", vn: "trở nên cực kì tức giận hoặc hào hứng" },
    { id: 73, en: "Go the extra mile", vn: "nỗ lực nhiều hơn mong đợi của bạn" },
    { id: 74, en: "Grease someone’s palm", vn: "hối lộ, bí mật đưa tiền" },
    { id: 75, en: "Green thumb", vn: "người giỏi về trồng trọt, trồng vườn" },
    { id: 76, en: "Have bigger fish to fry", vn: "có một điều gì quan trọng hơn để làm" },
    { id: 77, en: "Have egg on your face", vn: "cảm thấy xấu hổ, ngu ngốc vì những điều đã làm" },
    { id: 78, en: "Keep your ear to the ground", vn: "lắng nghe hay chú ý đến những xu hướng mới" },
    { id: 79, en: "Hard of hearing", vn: "nghe không rõ, nghe không tốt, lãng tai" },
    { id: 80, en: "He laughs best who laughs last", vn: "cười người chớ vội cười lâu" },
    { id: 81, en: "Head start", vn: "thuận lợi, ưu thế có trước" },
    { id: 82, en: "Hit the bottle", vn: "uống nhiều rượu, nhậu nhẹt" },
    { id: 83, en: "Hit the hay", vn: "đi ngủ" },
    { id: 84, en: "Hit the jackpot", vn: "trúng mánh, trúng số, đột nhiên kiếm được rất nhiều tiền" },
    { id: 85, en: "Hit the nail on the head", vn: "nói đúng trọng tâm vấn đề" },
    { id: 86, en: "Hold your tongue", vn: "đừng nói, không nói nữa" },
    { id: 87, en: "Hornet’s nest", vn: "tình huống khó khăn, không dễ chịu" },
    { id: 88, en: "Hot off the press", vn: "vừa xuất hiện trên báo" },
    { id: 89, en: "In a nutshell", vn: "nói tóm lại" },
    { id: 90, en: "In your salad days", vn: "khoảng thời gian còn trẻ, thiếu trải nghiệm" },
    { id: 91, en: "It strikes someone as strange", vn: "điều gì đó khiến ai lạ lùng" },
    { id: 92, en: "Itchy feet", vn: "người thích đi du lịch, đi phượt nhiều nơi" },
    { id: 93, en: "Jaw dropped", vn: "ngạc nhiên, sốc" },
    { id: 94, en: "Keep someone on a short leash", vn: "kiểm soát ai chặt chẽ" },
    { id: 95, en: "Keep your nose to the grindstone", vn: "làm việc chăm chỉ mà không nghỉ ngơi" },
    { id: 96, en: "Kick back", vn: "ngưng làm gì và nghỉ ngơi" },
    { id: 97, en: "Knock on wood", vn: "trộm vía, cầu may mắn" },
    { id: 98, en: "Lame excuse", vn: "cái cớ" },
    { id: 99, en: "Leave someone out in the cold", vn: "không cho phép ai trở thành một phần của nhóm, phớt lờ ai" },
    { id: 100, en: "Let bygones be bygones", vn: "cái gì qua hãy để nó qua, bỏ qua chuyện cũ" },
    { id: 101, en: "Let sleeping dogs lie", vn: "tránh nhắc lại chuyện gì đã qua, chuyện gì qua hãy để nó qua" },
    { id: 102, en: "Let someone in on a secret", vn: "cho phép ai đó biết điều gì đó mà bạn chưa nói với ai khác" },
    { id: 103, en: "Let the cat out of the bag", vn: "vô tình tiết lộ bí mật" },
    { id: 104, en: "Like a cat on a hot tin roof", vn: "dùng để chỉ người hay bồn chồn, lo lắng" },
    { id: 105, en: "Like water off a duck's back", vn: "không có tác dụng với ai (nước đổ đầu vịt)" },
    { id: 106, en: "Look for a needle in a haystack", vn: "mò kim đáy biển" },
    { id: 107, en: "Make a beeline for someone", vn: "đi thẳng đến ai đó/ cái gì đó" },
    { id: 108, en: "Make a mountain out of a molehill", vn: "việc bé xé ra to" },
    { id: 109, en: "Meet the deadline", vn: "hoàn thành một công việc nào đó đúng thời hạn" },
    { id: 110, en: "Miss the boat", vn: "đánh mất cơ hội" },
    { id: 111, en: "Money laundering", vn: "hoạt động rửa tiền" },
    { id: 112, en: "Move heaven and earth", vn: "làm mọi thứ bạn có thể, xoay sở đủ trò" },
    { id: 113, en: "No hard feelings", vn: "không giận chứ, không buồn chứ" },
    { id: 114, en: "Occupational hazard", vn: "sự nguy hiểm nghề nghiệp" },
    { id: 115, en: "Off the hook", vn: "thoát khỏi trở ngại, khó khăn" },
    { id: 116, en: "Off the top of your head", vn: "nói ngay không cần suy nghĩ, đã biết sẵn" },
    { id: 117, en: "On tap", vn: "có sẵn để dùng được ngay giống như nước trong vòi chảy ra" },
    { id: 118, en: "On the ropes", vn: "làm một cách tệ hại và có khả năng thất bại" },
    { id: 119, en: "Open a can of worms", vn: "gây ra tình huống rắc rối hay khó chịu" },
    { id: 120, en: "Out of the frying pan into the fire", vn: "tránh vỏ dưa gặp vỏ dừa" },
    { id: 121, en: "Paint the town red", vn: "đi chơi, đến các quán rượu, đi bar" },
    { id: 122, en: "Party animal", vn: "người rất thích tiệc tùng" },
    { id: 123, en: "Pass the baton", vn: "trao lại trọng trách hoặc công việc cho người khác" },
    { id: 124, en: "Peeping Tom", vn: "người hay nhìn trộm phụ nữ thay quần áo" },
    { id: 125, en: "Pop the question", vn: "cầu hôn" },
    { id: 126, en: "Pour one’s heart out to someone", vn: "dốc bầu tâm sự" },
    { id: 127, en: "Pour cold water on something", vn: "chỉ trích ý kiến hoặc ý tưởng của ai đó" },
    { id: 128, en: "Pull the rug out", vn: "đột nhiên lấy đi sự hỗ trợ quan trọng từ ai đó" },
    { id: 129, en: "Put a sock in it", vn: "im lặng đi!" },
    { id: 130, en: "Put someone in their place", vn: "chỉ ra cho ai thấy họ ít quan trọng hơn họ nghĩ" },
    { id: 131, en: "Put someone in the picture", vn: "nói với ai về một sự thật" },
    { id: 132, en: "Put someone to bed", vn: "bắt ai đi ngủ" },
    { id: 133, en: "Put something to sleep", vn: "giết động vật bị ốm hoặc quá già" },
    { id: 134, en: "Put the cart before the horse", vn: "làm những việc không đúng thứ tự, cầm đèn chạy trước ô tô" },
    { id: 135, en: "Throw a spanner in the works", vn: "làm gì để ngăn cái gì thành công, thọc gậy bánh xe" },
    { id: 136, en: "Read between the lines", vn: "Hiểu được ẩn ý hay sự thật đằng sau một tài liệu hay hành động nào" },
    { id: 137, en: "Reap what you have sown", vn: "gieo nhân nào gặt quả nấy" },
    { id: 138, en: "Rome wasn’t built in a day", vn: "những việc phức tạp cần thời gian và tính kiên nhẫn mới hoàn thành" },
    { id: 139, en: "Run its course", vn: "phát triển và kết thúc một cách tự nhiên" },
    { id: 140, en: "Seize the day", vn: "quý trọng ngày tháng, nắm bắt thời cơ" },
    { id: 141, en: "Set someone straight", vn: "nói cho ai đó sự thật về một tình huống mà người đó chưa hiểu" },
    { id: 142, en: "Shame on you", vn: "thật đáng xấu hổ cho bạn" },
    { id: 143, en: "Shoot yourself in the foot", vn: "một người có ý làm hại người khác, nhưng rốt cuộc lại làm hại chính mình" },
    { id: 144, en: "Shopping spree", vn: "mua sắm giải khuây, mua nhiều thứ một lúc" },
    { id: 145, en: "Shut one’s eyes", vn: "nhắm mắt làm ngơ" },
    { id: 146, en: "Sick to death", vn: "chán, ngán, ngấy" },
    { id: 147, en: "Sit on the fence", vn: "trì hoãn đưa ra quyết định, trung lập, không theo phe nào" },
    { id: 148, en: "Skeleton in the closet", vn: "bí mật đáng xấu hổ" },
    { id: 149, en: "Sleep on it", vn: "suy nghĩ từ từ trước khi đưa ra quyết định" },
    { id: 150, en: "Slippery slope", vn: "chiều hướng có thể dễ dàng dẫn đến thất bại, tai họa" },
    { id: 151, en: "Smell a rat", vn: "hoài nghi" },
    { id: 152, en: "Spill the beans", vn: "tiết lộ bí mật" },
    { id: 153, en: "Stab someone in the back", vn: "đâm sau lưng người nào đó" },
    { id: 154, en: "Stay the course", vn: "tiếp tục làm một cái gì đó cho đến khi nó kết thúc" },
    { id: 155, en: "Storm in a teacup", vn: "việc bé xé ra to, phóng đại sự việc" },
    { id: 156, en: "Strike while the iron is hot", vn: "tận dụng cơ hội đang có" },
    { id: 157, en: "Swallow your pride", vn: "kìm nén tự ái, nén sự kiêu hãnh" },
    { id: 158, en: "Sweep someone off their feet", vn: "làm cho ai cực kỳ xúc động" },
    { id: 159, en: "Take a back seat", vn: "chỉ tham gia một phần ít nổi bật trong việc gì" },
    { id: 160, en: "Take someone for a ride", vn: "lừa gạt, chơi xỏ ai đó" },
    { id: 161, en: "Take someone under your wing", vn: "che chở và bảo bọc ai đó" },
    { id: 162, en: "Take something amiss", vn: "không hiểu/hiểu nhầm cái gì đó" },
    { id: 163, en: "Take with a grain of salt", vn: "Không hoàn toàn tin tưởng cái gì đó" },
    { id: 164, en: "Tear your hair out", vn: "vò đầu bứt tóc" },
    { id: 165, en: "Temper tantrum", vn: "cơn la hét giận dữ, khóc mếu, ăn vạ (trẻ em)" },
    { id: 166, en: "Tempt fate", vn: "liều mạng, hành động liều lĩnh" },
    { id: 167, en: "The apple doesn't fall far from the tree", vn: "con nhà tông không giống lông cũng giống cánh" },
    { id: 168, en: "The big picture", vn: "toàn cảnh, bức tranh toàn cảnh" },
    { id: 169, en: "The blind leading the blind", vn: "người mù dẫn đường người mù đi" },
    { id: 170, en: "The dust settles", vn: "mọi chuyện dịu lại, bình tĩnh lại, lắng xuống" },
    { id: 171, en: "The in thing", vn: "thứ thịnh hành, thời thượng" },
    { id: 172, en: "The light at the end of the tunnel", vn: "dấu hiệu cho biết việc gì sẽ sớm thoát khỏi hoàn cảnh khó khăn" },
    { id: 173, en: "The more the merrier", vn: "càng đông càng vui" },
    { id: 174, en: "The night is young", vn: "vẫn còn sớm mà" },
    { id: 175, en: "The pros and cons", vn: "ưu điểm và khuyết điểm" },
    { id: 176, en: "The time is ripe", vn: "thời điểm thích hợp" },
    { id: 177, en: "The whole nine yards", vn: "toàn bộ một cái gì đó" },
    { id: 178, en: "Think outside the box", vn: "suy nghĩ một cách sáng tạo, không đi theo lối cũ" },
    { id: 179, en: "Third time is a charm", vn: "lần thứ ba sẽ thành công, quá tam ba bận" },
    { id: 180, en: "Through thick and thin", vn: "bất chấp mọi hoàn cảnh khó khăn" },
    { id: 181, en: "Throw caution to the wind", vn: "làm cái gì mà không lo lắng về hậu quả" },
    { id: 182, en: "Throw in the towel", vn: "thừa nhận thất bại" },
    { id: 183, en: "Throw someone under the bus", vn: "làm điều gì đó có hại cho người khác để giành lợi thế cho mình" },
    { id: 184, en: "Time bomb", vn: "bom hẹn giờ, bom nổ chậm" },
    { id: 185, en: "Time is money", vn: "thời gian là vàng" },
    { id: 186, en: "Toss a coin", vn: "tung đồng xu, lấy hên xui" },
    { id: 187, en: "Turn a blind eye", vn: "vờ như không thấy, nhắm mắt làm ngơ" },
    { id: 188, en: "Turn the tables on someone", vn: "giành lại ưu thế so với ai, làm đảo lộn lại tình thế đối với ai" },
    { id: 189, en: "Twenty-four seven", vn: "24 trên 7, mọi lúc" },
    { id: 190, en: "Twist someone’s arm", vn: "thuyết phục ai làm việc gì đó" },
    { id: 191, en: "Under oath", vn: "thề nói thật trước tòa" },
    { id: 192, en: "Under the table", vn: "bí mật" },
    { id: 193, en: "Walk a tightrope", vn: "xem xét cẩn thận các quyết định hoặc rủi ro" },
    { id: 194, en: "Walking on thin ice", vn: "hoàn cảnh khó khăn dễ dẫn đến thất bại" },
    { id: 195, en: "Wee hours", vn: "nửa đêm" },
    { id: 196, en: "While there’s life, there’s hope", vn: "còn nước còn tát" },
    { id: 197, en: "White elephant", vn: "một cái gì đó tốn rất nhiều tiền nhưng không hữu ích" },
    { id: 198, en: "With flying colors", vn: "rất dễ dàng, kết quả mĩ mãn" },
    { id: 199, en: "Work like a beaver", vn: "làm việc đầu tắt mặt tối" },
    { id: 200, en: "Your mind goes blank", vn: "đầu óc trống rỗng, không nhớ được điều gì đặc biệt" }
  ];

  // Logic to process a question: Hide one random word
  const generateQuestion = () => {
    // Pick random idiom
    const randomIdx = Math.floor(Math.random() * rawData.length);
    const idiom = rawData[randomIdx];
    
    // Split into words, removing punctuation attached to words for splitting purposes
    const words = idiom.en.split(' ');
    
    // Filter words eligible to be hidden (length > 2 and not super common stop words to make it meaningful)
    const candidates = words.map((w, i) => ({ word: w, index: i })).filter(item => {
      const cleanWord = item.word.replace(/[^a-zA-Z]/g, '').toLowerCase();
      return cleanWord.length > 2 && !['the', 'and', 'for', 'with', 'one', 'you'].includes(cleanWord);
    });

    // If no good candidates (rare), just pick any word
    const target = candidates.length > 0 
      ? candidates[Math.floor(Math.random() * candidates.length)] 
      : { word: words[0], index: 0 };

    const parts = [...words];
    const missingWord = target.word.replace(/[^a-zA-Z0-9’'-]/g, ''); // Keep apostrophes inside word
    parts[target.index] = "_____";

    setCurrentQuestion({
      original: idiom,
      displayParts: parts,
      missingIndex: target.index,
      answer: missingWord,
      fullText: parts.join(' ')
    });
    setUserInput('');
    setFeedback(null);
    
    // Auto focus input
    setTimeout(() => {
      if(inputRef.current) inputRef.current.focus();
    }, 100);
  };

  useEffect(() => {
    generateQuestion();
  }, []);

  const handleSubmit = (e) => {
    e.preventDefault();
    if (feedback !== null) {
      // If already answered, go to next
      handleNext();
      return;
    }

    if (!userInput.trim()) return;

    // Normalize check
    const cleanUser = userInput.trim().toLowerCase();
    const cleanAnswer = currentQuestion.answer.toLowerCase();

    const isCorrect = cleanUser === cleanAnswer;

    setFeedback(isCorrect ? 'correct' : 'incorrect');
    
    setStats(prev => ({
      correct: prev.correct + (isCorrect ? 1 : 0),
      total: prev.total + 1
    }));
  };

  const handleNext = () => {
    generateQuestion();
  };

  const calculateScore = () => {
    if (stats.total === 0) return 0;
    return ((stats.correct / stats.total) * 10).toFixed(1);
  };

  // Skip functionality
  const handleSkip = () => {
    setStats(prev => ({
       ...prev,
       total: prev.total + 1
    }));
    generateQuestion();
  }

  return (
    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4 font-sans text-slate-800">
      <div className="max-w-xl w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
        
        {/* Header */}
        <div className="bg-blue-600 p-6 text-white flex justify-between items-center">
          <div>
            <h1 className="text-xl font-bold flex items-center gap-2">
              <BookOpen className="w-5 h-5" />
              Ôn Tập Thành Ngữ
            </h1>
            <p className="text-blue-100 text-sm mt-1">Điền từ còn thiếu vào chỗ trống</p>
          </div>
          <div className="text-right">
             <div className="flex items-center gap-2 justify-end">
               <Trophy className="w-4 h-4 text-yellow-300" />
               <span className="text-2xl font-bold">{calculateScore()}</span>
               <span className="text-xs opacity-80">/ 10</span>
             </div>
             <div className="text-xs text-blue-100">
               Đúng: {stats.correct}/{stats.total}
             </div>
          </div>
        </div>

        {/* Content */}
        <div className="p-8">
          {currentQuestion && (
            <div className="space-y-8">
              
              {/* Meaning Card */}
              <div className="bg-slate-50 p-4 rounded-lg border-l-4 border-blue-500">
                <span className="text-xs font-semibold text-slate-400 uppercase tracking-wider block mb-1">
                  Nghĩa Tiếng Việt
                </span>
                <p className="text-lg font-medium text-slate-700">
                  {currentQuestion.original.vn}
                </p>
              </div>

              {/* Question Area */}
              <div className="text-center space-y-6">
                <div className="text-2xl md:text-3xl leading-relaxed font-serif text-slate-800">
                  {currentQuestion.displayParts.map((part, index) => (
                    <span key={index} className="mx-1 inline-block">
                      {index === currentQuestion.missingIndex ? (
                         feedback === null ? (
                            <span className="text-blue-600 font-bold border-b-2 border-blue-600 min-w-[80px] inline-block text-center">
                              {userInput || "_____"}
                            </span>
                         ) : (
                           <span className={`${feedback === 'correct' ? 'text-green-600 border-green-600' : 'text-red-500 border-red-500'} font-bold border-b-2 min-w-[80px] inline-block text-center`}>
                              {userInput}
                           </span>
                         )
                      ) : (
                        <span>{part}</span>
                      )}
                    </span>
                  ))}
                </div>

                {/* Feedback Message */}
                {feedback && (
                  <div className={`flex items-center justify-center gap-2 text-lg font-bold animate-pulse ${feedback === 'correct' ? 'text-green-600' : 'text-red-500'}`}>
                    {feedback === 'correct' ? (
                      <>
                        <CheckCircle className="w-6 h-6" />
                        Chính xác!
                      </>
                    ) : (
                      <>
                        <XCircle className="w-6 h-6" />
                        Sai rồi!
                      </>
                    )}
                  </div>
                )}
              </div>

              {/* Interaction Area */}
              <form onSubmit={handleSubmit} className="mt-8">
                {feedback === null ? (
                  <div className="flex gap-2">
                    <input
                      ref={inputRef}
                      type="text"
                      value={userInput}
                      onChange={(e) => setUserInput(e.target.value)}
                      placeholder="Nhập từ còn thiếu..."
                      className="flex-1 px-4 py-3 text-lg border-2 border-slate-300 rounded-xl focus:border-blue-500 focus:outline-none transition-colors shadow-sm"
                      autoComplete="off"
                      autoCorrect="off"
                    />
                    <button 
                      type="submit"
                      disabled={!userInput.trim()}
                      className="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-3 rounded-xl font-bold transition-all shadow-md active:transform active:scale-95"
                    >
                      Kiểm tra
                    </button>
                  </div>
                ) : (
                  <button 
                    type="button"
                    onClick={handleNext}
                    ref={inputRef} // Focus this button so user can press enter to go next
                    className="w-full bg-slate-800 hover:bg-slate-900 text-white px-6 py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg text-lg"
                  >
                    Câu tiếp theo <ArrowRight className="w-5 h-5" />
                  </button>
                )}
              </form>

               {/* Footer Controls */}
               {feedback === null && (
                 <div className="flex justify-center mt-4">
                    <button 
                      onClick={handleSkip}
                      className="text-slate-400 hover:text-slate-600 text-sm font-medium flex items-center gap-1 transition-colors"
                    >
                      <RefreshCw className="w-3 h-3" /> Bỏ qua câu này
                    </button>
                 </div>
               )}

            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default IdiomApp;